#!/usr/bin/env bash

font="Ubuntu Nerd Font:bold:pixelsize=18"

if [ -n "$(pidof sway)" ]; then
  locker="swaylock"
fi

if [ -n "$(pidof i3)" ]; then
  locker="i3-lock"
fi

# Функция системных событий (завершение процессов, блокировка экрана, перезагрузка, выключение)
sys_menu() {
  case "$(printf "kill\nlock\nlogout\nreboot\nshutdown" | dmenu -i -fn "$font" -c -l 5)" in
  kill) ps -u "$USER" -o pid,comm,%cpu,%mem | dmenu -i -fn "$font" -c -l 10 -p Kill: | awk '{print $1}' | xargs -r kill ;;
    #	lock) slock systemctl suspend -i ;;
  lock) $locker -i "$HOME/.local/backgrounds/wm-lock.png" ;;
  logout) i3-msg exit ;;
  reboot) systemctl reboot -i ;;
  shutdown) shutdown now ;;
  *) exit 1 ;;
  esac
}

# Функция переключения аудиовыходов
audio_switch() {
  # Create a list of sinks with pretty names
  options=$(pactl -f json list sinks | jq -r '.[] | .description')
  # Let the user select a description
  selection=$(echo "$options" | dmenu -i -fn "$font" -l 5 -c -p "Output:")
  # Extract the corresponding sink name
  sink_name=$(pactl -f json list sinks | jq -r --arg sink_pretty_name "$selection" '.[] | select(.description == $sink_pretty_name) | .name')
  # Set the selected sink as default
  if [ -n "$sink_name" ]; then
    pactl set-default-sink "$sink_name" && notify-send "Audio switched to: $selection"
  else
    notify-send "Audio switch failed"
  fi
}

# Функция управления заметками
folder=$HOME/.notes/

newnote() {
  name="$(echo "" | dmenu -fn "$font" -c -p "Enter a name: " <&-)" || exit 0
  : "${name:=$(date +%F_%T | tr ':' '-')}"
  setsid -f "$TERMINAL" -e nvim "$folder$name.md" >/dev/null 2>&1
}

shownotes() {
  if [ ! -d "$folder" ]; then
    mkdir "$folder"
  fi
  choice=$(echo -e "New\n$(command ls -t1 "$folder")" | dmenu -c -l 5 -i -fn "$font" -p "Choose note or create new: ")
  case $choice in
  New) newnote ;;
  *.md) setsid -f "$TERMINAL" -e nvim "$folder$choice" >/dev/null 2>&1 ;;
  *) exit ;;
  esac
}

case "$1" in
audio)
  audio_switch
  ;;
notes)
  shownotes
  ;;
*)
  sys_menu
  ;;
esac

unset "$folder", "$font", "locker"

#vim: ft=sh
